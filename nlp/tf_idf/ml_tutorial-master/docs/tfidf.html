---

title: Text Search using TF-IDF and Elasticsearch

keywords: fastai
sidebar: home_sidebar

summary: "Summary: Information Retrieval, tf-idf, Elasticsearch, Text Matching"
description: "Summary: Information Retrieval, tf-idf, Elasticsearch, Text Matching"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 08_tfidf.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-is-TF-IDF?">What is TF-IDF?<a class="anchor-link" href="#What-is-TF-IDF?"> </a></h2><p>TF-IDF stands for "Term Frequency — Inverse Document Frequency". It is a statistical technique that quantifies the importance of a word in a document based on how often it appears in that document and a given collection of documents (corpus). The intuition for this measure is : If a word occurs frequently in a document, then it should be more important and relevant than other words that appear fewer times and we should give that word a high score (TF). But if a word appears many times in a document but also in too many other documents, it’s probably not a relevant and meaningful word, therefore we should assign a lower score to that word (IDF). The relevancy of a word is proportional to the amount of information that it gives about its context (a sentence, a document or a full dataset). The more relevant words help us better understand the entire document without reading it completely. The most relevant words are not necessary the most frequent words since <strong>stopwords</strong> like "the", "of" or "a" tend to occur very often in many documents, but do not give much information. TF-IDF method is widely used in Information Retrieval and Text Mining. The TF-IDF score of term $t$ in document $d$ with respect to corpus $D$ is:</p>
<p>{% raw %}
$$tfidf(t,d,D)=tf(t,d)\times idf(d,D)$$
{% endraw %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Term-Frequency-(TF)-Score">Term Frequency (TF) Score<a class="anchor-link" href="#Term-Frequency-(TF)-Score"> </a></h3><p>First we have to calculate the $tf(t,d)$, which is simply the number of times each word $t$ appeared in document $d$. While calculating $tf(t,d)$, we usually remove words like "a", "as", "the". These words are called stopwords and will not provide much information. Additionally, there could be many high frequency non-stopwords that do not provide much information in a given context (e.g., “Disney” in a collection of documents about “Disney World”), Therefore, we can filter them out too. Also, we normalize the term-frequency to make sure there is no bias for longer or shorter documents. Thus, we have:</p>
<p>{% raw %}
$$tf(t,d)=\frac{f_{t,d}}{\sum_{t'} f_{t',d}}$$
{% endraw %}</p>
<p>where $f_{t,d}$ is the number of occurances of $t$ in $d$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inverse-Document-Frequency-(IDF)">Inverse Document Frequency (IDF)<a class="anchor-link" href="#Inverse-Document-Frequency-(IDF)"> </a></h3><p>It measures how rare a term $t$ is across the corpus $D$, meaning how much information it provides about a document it appears in. If  total number of documents in the corpus is $N=|D|$, and $n_t$ is the number of documents having $t$, then we have:</p>
<p>{% raw %}
$$idf(t,D)=\log(\frac{N}{n_t})$$
{% endraw %}</p>
<p>The reason that we take the $\log$ of IDF is that if we have a large corpus, the IDF values will become so large, therefore,  we use the $\log$ value to decrease that effect.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="TF-IDF-Example">TF-IDF Example<a class="anchor-link" href="#TF-IDF-Example"> </a></h3><p>In order to fully understand how TF-IDF works, I will give you a concrete example. Let's assume that we have a collection of four documents as follows:</p>
<ul>
<li><p>$d_1$: "<em>The sky is blue.</em></p>
</li>
<li><p>$d_2$: "<em>The sun is bright today.</em>"</p>
</li>
<li><p>$d_3$: "<em>The sun in the sky is bright.</em>"</p>
</li>
<li><p>$d_4$: "<em>We can see the shining sun, the bright sun.</em>"</p>
</li>
</ul>
<p><strong>Task:</strong> Determine the tf-idf scores for each term in each document.</p>
<ul>
<li><p><strong>Step1:</strong> Filter out the stopwords. After removing the stopwords, we have</p>
<ul>
<li><p>$d_1$: "<em>sky blue</em></p>
</li>
<li><p>$d_2$: "<em>sun bright today</em>"</p>
</li>
<li><p>$d_3$: "<em>sun sky bright</em>"</p>
</li>
<li><p>$d_4$: "<em>can see shining sun bright sun</em>"</p>
</li>
</ul>
</li>
<li><p><strong>Step2:</strong> Compute TF, therefore, we find document-word matrix and then normalize the rows to sum to 1.</p>
</li>
</ul>
<p><img src="/ml_tutorial/images/tfidf_ex1.png" alt="">
<em>TF score computation. [<a href="http://www.cbrinton.net/ECE20875-2020-Spring/W10/ngrams.pdf">Image Source</a>]</em></p>
<ul>
<li><strong>Step3:</strong> Compute IDF: Find the number of documents in which each word occurs, then compute the formula:</li>
</ul>
<p><img src="/ml_tutorial/images/tfidf_ex2.png" alt="">
<em>IDF score computation. [<a href="http://www.cbrinton.net/ECE20875-2020-Spring/W10/ngrams.pdf">Image Source</a>]</em></p>
<ul>
<li><strong>Step4:</strong> Compute TF-IDF: Multiply TF and IDF scores.</li>
</ul>
<p><img src="/ml_tutorial/images/tfidf_ex3.png" alt="">
<em>TF-IDF score computation. [<a href="http://www.cbrinton.net/ECE20875-2020-Spring/W10/ngrams.pdf">Image Source</a>]</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Application-of-tf-idf-for-Searching-Text">Application of tf-idf for Searching Text<a class="anchor-link" href="#Application-of-tf-idf-for-Searching-Text"> </a></h3><p>In order to understand how to use tf-idf, I am going to make use of this technique in a text searching application. I will use a dataset of <a href="https://www.kaggle.com/stackoverflow/pythonquestions">Python questions and answers from Stackoverflow</a>. The dataset contains all the questions (around 700,000) asked between August 2, 2008 and Ocotober 19, 2016. Please see the link for all the details about this dataset. For this application, I only use the Python questions. However, it would be an interesting exercise to create a question-answering application. Each question in this file contains <code>title</code> and <code>body</code> among other attributes. But I will merely use these two fields from each question in the file.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Implementation">Implementation<a class="anchor-link" href="#Implementation"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="preprocess" class="doc_header"><code>preprocess</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L7" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>preprocess</code>(<strong><code>title</code></strong>, <strong><code>body</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Preprocess the input, i.e. lowercase, remove html tags, special character and digits.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_tfidf_features" class="doc_header"><code>create_tfidf_features</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_tfidf_features</code>(<strong><code>corpus</code></strong>, <strong><code>max_features</code></strong>=<em><code>5000</code></em>, <strong><code>max_df</code></strong>=<em><code>0.95</code></em>, <strong><code>min_df</code></strong>=<em><code>2</code></em>)</p>
</blockquote>
<p>Creates a tf-idf matrix for the <code>corpus</code> using sklearn.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="calculate_similarity" class="doc_header"><code>calculate_similarity</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>calculate_similarity</code>(<strong><code>X</code></strong>, <strong><code>vectorizor</code></strong>, <strong><code>query</code></strong>, <strong><code>top_k</code></strong>=<em><code>5</code></em>)</p>
</blockquote>
<p>Vectorizes the <code>query</code> via <code>vectorizor</code> and calculates the cosine similarity of
the <code>query</code> and <code>X</code> (all the documents) and returns the <code>top_k</code> similar documents.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="show_similar_documents" class="doc_header"><code>show_similar_documents</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>show_similar_documents</code>(<strong><code>df</code></strong>, <strong><code>cosine_similarities</code></strong>, <strong><code>similar_doc_indices</code></strong>)</p>
</blockquote>
<p>Prints the most similar documents using indices in the <code>similar_doc_indices</code> vector.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First step is to read and load the <code>questions.csv</code> file. Please note that it may take several seconds to fully load the file due to large number of records (607282 questions) in the file.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Reading the csv file of python Questions</span>
<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;stackoverflow&#39;</span><span class="p">,</span><span class="s1">&#39;Questions.csv&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading the Questions file...&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Reading the Questions file...
done
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>OwnerUserId</th>
      <th>CreationDate</th>
      <th>Score</th>
      <th>Title</th>
      <th>Body</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>469</td>
      <td>147.0</td>
      <td>2008-08-02T15:11:16Z</td>
      <td>21</td>
      <td>How can I find the full path to a font from it...</td>
      <td>&lt;p&gt;I am using the Photoshop's javascript API t...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>502</td>
      <td>147.0</td>
      <td>2008-08-02T17:01:58Z</td>
      <td>27</td>
      <td>Get a preview JPEG of a PDF on Windows?</td>
      <td>&lt;p&gt;I have a cross-platform (Python) applicatio...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>535</td>
      <td>154.0</td>
      <td>2008-08-02T18:43:54Z</td>
      <td>40</td>
      <td>Continuous Integration System for a Python Cod...</td>
      <td>&lt;p&gt;I'm starting work on a hobby project with a...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>594</td>
      <td>116.0</td>
      <td>2008-08-03T01:15:08Z</td>
      <td>25</td>
      <td>cx_Oracle: How do I iterate over a result set?</td>
      <td>&lt;p&gt;There are several ways to iterate over a re...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>683</td>
      <td>199.0</td>
      <td>2008-08-03T13:19:16Z</td>
      <td>28</td>
      <td>Using 'in' to match an attribute of Python obj...</td>
      <td>&lt;p&gt;I don't remember whether I was dreaming or ...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's take a look at a randomly selected question.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sample_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_index</span><span class="p">,[</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="s1">&#39;Body&#39;</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;title: </span><span class="si">{}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">body: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">],</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>title: Python: print() always writes to .ipynb making file too large, 
body: &lt;p&gt;To cut to the chase, I&#39;d like to know how to make print statements display in ipython notebooks while simultaneously preventing those statements from saving to the .ipynb file. The purpose being to make a progress bar which doesn&#39;t make the file size ridiculously large.&lt;/p&gt;

&lt;p&gt;The background to this is that I&#39;ve been writing a bit of python code which makes a bunch of png files so that I can eventually compile them into a GIF. While I was doing this I thought I&#39;d be clever and print the progress of the task as it went using &lt;code&gt;print()&lt;/code&gt; from &lt;code&gt;__future__&lt;/code&gt; with carriage returns. Unfortunately though I&#39;ve had two problem with my code, both of which I imagine are related to my implementation of this progress message.&lt;/p&gt;

&lt;p&gt;The first problem is with github&#39;s limit on file size:&lt;/p&gt;

&lt;p&gt;When I first tried to upload my file to github it prevented me from doing so because it exceeded their 100 MB limit. After investigating my .ipynb file I found that there was an obscene number of print statements which were being saved there. Initially I&#39;d thought that including &lt;code&gt;&#39;\r&#39;&lt;/code&gt; to do carriage returns would prevent this, but clearly that&#39;s not the case.&lt;/p&gt;

&lt;p&gt;The second problem is probably related to this:&lt;/p&gt;

&lt;p&gt;Typically I don&#39;t have a problem creating the first few GIFs especially if I don&#39;t include that many frames, however beyond that my python notebook crashes. If this were a typical memory problem I&#39;d imagine that it would just throw an error at me, but it doesn&#39;t, and instead promptly dies on me.&lt;/p&gt;

&lt;p&gt;Here&#39;s a sample of the sort of stuff that&#39;s bloating the .ipynb file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
   &#34;output_type&#34;: &#34;stream&#34;,
   &#34;stream&#34;: &#34;stdout&#34;,
   &#34;text&#34;: [
    &#34;\r&#34;,
    &#34;frame 1 -- 0.480% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.500% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.520% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.540% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.560% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.580% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.600% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.620% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.640% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.660% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.680% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.700% complete -- U_avg = -7.200000\r&#34;,
    &#34;frame 1 -- 0.720% complete -- U_avg = -7.200000\r&#34;, ......
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I&#39;ve looked into how other people have implemented progress bars, however they don&#39;t appear to do anything special which would actually prevent the problem I&#39;m having. If it comes down to it, I wouldn&#39;t mind importing something which would solve this problem in a black box, but at the same time if I run into this issue in a different context it would be useful to know how to reduce .ipynb file sizes by cutting out saved print statements.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Preprocessing is one of the major steps when we are dealing with any kind of text models. As you can see above, the <code>body</code> of the question, it's true for all the questions, has plently of html tags and special characters. Therefore, we need to get rid of them as much as we can. The <code>preprocess()</code> function will carry out cleaning of the questions by removing html tags, special characters and digits. As usual, there is always room for improvements by adding more cleaning rules such as <em>stemming</em>, <em>lematization</em>, <em>stop words removal</em>, etc.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Preprocess the corpus</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">])]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After we load and clean the data, it's time to create the <code>term-document</code> matrix. We can write simple functions for computing tf (term frequency) and idf (inverse document frequency). However, I leave this out as an interesting exercise. Instead I'll be using sklearn <code>TfidfVectorizer</code> to compute the word counts, idf and tf-idf values all at once. You can find all the details about <code>TfidfVectorizer</code> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html#sklearn.feature_extraction.text.TfidfVectorizer.transform">here</a>. I would like to mention that in <code>create_tfidf_features()</code> function, I restrict the size of the vocabulary (i.e. number of features) to 5000 to make the computations cheaper.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;creating tfidf matrix...&#39;</span><span class="p">)</span>
<span class="c1"># Learn vocabulary and idf, return term-document matrix</span>
<span class="n">X</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">create_tfidf_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>creating tfidf matrix...
tfidf matrix successfully created.
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>5000</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now it's time to test and see how our application works. We can ask an arbitrary question and see if the system can find the top-k most similar questions from the dataset to our question.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">user_question</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;how to loop over files in a directory&#39;</span><span class="p">]</span>
<span class="n">search_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">sim_vecs</span><span class="p">,</span> <span class="n">cosine_similarities</span> <span class="o">=</span> <span class="n">calculate_similarity</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">user_question</span><span class="p">)</span>
<span class="n">search_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">search_start</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;search time: </span><span class="si">{:.2f}</span><span class="s2"> ms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">show_similar_documents</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cosine_similarities</span><span class="p">,</span> <span class="n">sim_vecs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>search time: 380.51 ms

Top-1, Similarity = 0.6605864924688081
body: loop through fixed number of files within a directory how can i loop through a fixed number of files within a directory with glob glob if there s more than x files within that directory i only want to loop through x and then exit the loop how do i do this, 

Top-2, Similarity = 0.6436681516641347
body: how to list all files of a directory in python how can i list all files of a directory in python and add them to a list, 

Top-3, Similarity = 0.5968769006998226
body: extract all zipped files to same directory using python i have a large amount of zipped files in a single directory that i would like to decompress and save them to the same directory and with the same name as the zipped file, 

Top-4, Similarity = 0.5377592889154766
body: deleting all files in a directory with python i want to delete all files with the extension bak in a directory how can i do that in python, 

Top-5, Similarity = 0.5202741533554684
body: move files from one directory to another based on a specific line i have some text files in a directory i would like to read all the files in this directory and if the file has the following line sample an integer of type decimal can be assembled by move that file with its all contents to another directory how can i do this, 

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-Use-Elasticsearch-for-Indexing-and-Retrieving-Text">How to Use Elasticsearch for Indexing and Retrieving Text<a class="anchor-link" href="#How-to-Use-Elasticsearch-for-Indexing-and-Retrieving-Text"> </a></h2><h3 id="What-is-Elasticsearch?">What is Elasticsearch?<a class="anchor-link" href="#What-is-Elasticsearch?"> </a></h3><p><a href="https://www.elastic.co/downloads/elasticsearch">Elasticsearch</a> is an open source distributed, RESTful search and analytics engine. Elasticsearch enables us to index, search, and analyze data at large scale. It provides real-time search and analytics for various types of data including structured or unstructured text, numerical data, or geospatial data. Elasticsearch can efficiently store and index it in a way that supports fast searches. In order to learn Elasticsearch please see the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-install.html">documentation</a>. It is out of the scope of this tutorial, so I leave it as an exercise to understand and learn how Elasticsearch works.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>
<span class="kn">from</span> <span class="nn">elasticsearch.helpers</span> <span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_index" class="doc_header"><code>create_index</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_index</code>(<strong><code>es_client</code></strong>)</p>
</blockquote>
<p>Creates an Elasticsearch index.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="index_data" class="doc_header"><code>index_data</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L92" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>index_data</code>(<strong><code>es_client</code></strong>, <strong><code>data</code></strong>, <strong><code>BATCH_SIZE</code></strong>=<em><code>100000</code></em>)</p>
</blockquote>
<p>Indexs all the rows in data (python questions).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="index_batch" class="doc_header"><code>index_batch</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L114" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>index_batch</code>(<strong><code>docs</code></strong>)</p>
</blockquote>
<p>Indexes a batch of documents.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_query_loop" class="doc_header"><code>run_query_loop</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L125" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_query_loop</code>()</p>
</blockquote>
<p>Asks user to enter a query to search.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="handle_query" class="doc_header"><code>handle_query</code><a href="https://github.com/sci2lab/ml_tutorial/tree/master/ml_tutorial/tfidf.py#L135" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>handle_query</code>()</p>
</blockquote>
<p>Searches the user query and finds the best matches using elasticsearch.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INDEX_NAME</span> <span class="o">=</span> <span class="s1">&#39;python_questions&#39;</span>
<span class="n">es_client</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
<span class="n">create_index</span><span class="p">(</span><span class="n">es_client</span><span class="p">)</span>
<span class="n">index_data</span><span class="p">(</span><span class="n">es_client</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating `Question` index...
index `Question` created successfully.
Indexed 100000 documents.
Indexed 200000 documents.
Indexed 300000 documents.
Indexed 400000 documents.
Indexed 500000 documents.
Indexed 600000 documents.
Indexed 607282 documents.
Done indexing.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">SEARCH_SIZE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">run_query_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;size&#39;: 3, &#39;query&#39;: {&#39;match&#39;: {&#39;body&#39;: &#39;how to loop over files in a directory&#39;}}}

10000 total hits.
search time: 17.38 ms
id: AnG2e3EBroreQxGKfg6x, score: 19.826128
{&#39;body&#39;: &#39;looping over filenames in python i have a zillion files in a directory i want a script to run on they all have a filename like prefix_foo_ _asdf_asdfasdf csv i know how to loop over files in a directory using a variable in the filename in shell but not python is there a corresponding way to do something like i for i lt process py prefix_foo_ i_ i endloop&#39;}

id: 8nW3e3EBroreQxGKGSnb, score: 19.142948
{&#39;body&#39;: &#39;iterate and delete the files in a directory i am trying to iterate over a few files from a directory then i am copying them in a group based on their initial name to a particular location and then deleting them from the current direcory but since i delete them after grouping them together i get a file not found exception when the loop move over to the next file which is deleted how can i resolve it here is my code import os import csv import glob fnmatch shutil time ftp_directory c cirp velocidata test ifind_location c cirp velocidata test getting the list of all files for root dirs files in os walk ftp_directory filtering for group names that are inprogress groups_beingworked for name in files getting the exception in the below line in the second iteration group name name lower find infile for loop in files if loop len group lower group groups_beingworked append loop for loop in groups_beingworked shutil copy os path join root loop ifind_location print deleting the file loop file removed from the ftp location through a ftp conn created elsewhere ftpconn delete os path join root loop list of sample files i am trying to go through is file new infile type file new infile type file old infile type file new infile type file old infile type file rec infile type&#39;}

id: fna3e3EBroreQxGKU39k, score: 18.82203
{&#39;body&#39;: &#39;python opening images in the fabio module by looping over a directory i m attempting to deal with cbf crystallographic binary format see below for link files in python i need a way of looping over all the files in the current directory example reading in first file in fabio dat raw_input please input required filename define the required filename as a string example input file cbf import fabio import fabio module for python img_ fabio open dat open image from defined filename this section of the code designed to open and display a file works perfectly fabio has a method of opening the next file available which is in this case of the format example img_ img_ next as i have already defined img_ in example this code would work how would i loop over all the files in the current directory without needing to execute the command in example for every file if there were files would it be something of the form example for i in range img_ i img_ i next how can i do this loop whilst also accounting for the leading zeros any help would be greatly appreciated thanks relevant information cbf files http www esrf eu computing forum imgcif cbf_definition html fabio module http pythonhosted org fabio getting_started html&#39;}

</pre>
</div>
</div>

<div class="output_area">


</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extra-Resources">Extra Resources<a class="anchor-link" href="#Extra-Resources"> </a></h2><p>[1] <a href="https://colab.research.google.com/drive/1VJzTxN1QYXdc9LOjVO4DWqpV7nY4okmD#scrollTo=cSxeZmIZJ858">Text Similarity Search for COVID-19 Dataset</a></p>
<p>[2] <a href="https://github.com/jtibshirani/text-embeddings">Text Embeddings in Elasticsearch</a></p>

</div>
</div>
</div>
</div>
 

